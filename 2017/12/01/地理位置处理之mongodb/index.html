<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>地理位置geo处理之mongodb geo 索引 | 麦田麦穗</title>

  
  <meta name="author" content="vison">
  

  
  <meta name="description" content="目前越来越多的业务都会基于LBS，附近的人，外卖位置，附近商家等等，现就讨论离我最近这一业务场景的解决方案。

目前已知解决方案有:

mysql 自定义函数计算
mysql geo索引
mongodb geo索引
postgresql PostGis索引
redis geo
ElasticSearch

本文测试下mongodb geo索引 函数运算的性能">
  

  
  
  <meta name="keywords" content="方案">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="地理位置geo处理之mongodb geo 索引"/>

  <meta property="og:site_name" content="麦田麦穗"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="麦田麦穗" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">麦田麦穗</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>地理位置geo处理之mongodb geo 索引</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2017/12/01/地理位置处理之mongodb/" rel="bookmark">
        <time class="entry-date published" datetime="2017-12-01T02:34:00.000Z">
          2017-12-01
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <blockquote>
<p>目前越来越多的业务都会基于LBS，附近的人，外卖位置，附近商家等等，现就讨论离我最近这一业务场景的解决方案。</p>
</blockquote>
<p>目前已知解决方案有:</p>
<ul>
<li>mysql 自定义函数计算</li>
<li>mysql geo索引</li>
<li>mongodb geo索引</li>
<li>postgresql PostGis索引</li>
<li>redis geo</li>
<li>ElasticSearch</li>
</ul>
<p>本文测试下mongodb geo索引 函数运算的性能</p>
<span id="more"></span>

<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="创建数据表"><a href="#创建数据表" class="headerlink" title="创建数据表"></a>创建数据表</h3><pre><code class="sql">db.driver.createIndex(&#123;loc: &quot;2dsphere&quot;&#125;)</code></pre>
<h2 id="创建数据python脚本"><a href="#创建数据python脚本" class="headerlink" title="创建数据python脚本"></a>创建数据python脚本</h2><pre><code class="python"># coding=utf-8
from pymongo import MongoClient
import logging
import random
import threading

&quot;&quot;&quot; 中国的经纬度范围 纬度3.86~53.55，经度73.66~135.05。大概0.00001度差距1米 &quot;&quot;&quot;

# 创建 日志 对象
logger = logging.getLogger()
handler = logging.StreamHandler()
formatter = logging.Formatter(
    &#39;%(asctime)s %(name)-12s %(levelname)-8s %(message)s&#39;)
handler.setFormatter(formatter)
logger.addHandler(handler)
logger.setLevel(logging.DEBUG)

# Connect to the mongodb database

mongoconn = MongoClient(&#39;127.0.0.1&#39;, 27017)
mdb = mongoconn.geo_analysis
driver_collection = mdb.driver


def ins_driver(thread_name, nums):
    logger.info(&#39;开启线程%s&#39; % thread_name)
    for i in range(nums):
        lng = &#39;%.5f&#39; % random.uniform(73.66, 135.05)
        lat = &#39;%.5f&#39; % random.uniform(3.86, 53.55)
        logging.debug(&#39;插入记录:%s&#39; % i)
        driver_collection.insert_one(&#123;
            &quot;loc&quot;:[
                float(lng),
                float(lat)
            ]
        &#125;)


thread_nums = 10
for i in range(thread_nums):
    t = threading.Thread(target=ins_driver, args=(i, 40000))
    t.start()
</code></pre>
<p><img src="http://upload-images.jianshu.io/upload_images/4033700-dda526bdfcc5c759.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<p>以上脚本创建10个线程，10个线程插入4万条数据。耗费52.43s执行完,总共插入40万条数据</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><ul>
<li>测试环境</li>
</ul>
<p>系统：mac os</p>
<p>内存：16G</p>
<p>cpu: intel core i5</p>
<p>硬盘: 500g 固态硬盘</p>
<p>测试下查找距离(134.38753,18.56734)附近20公里的司机</p>
<pre><code class="js">db.runCommand(&#123;geoNear:&#39;driver&#39;, near:[134.38753,18.56734], spherical:true, maxDistance:20000/6378000, distanceMultiplier:6378000&#125;);</code></pre>
<ul>
<li>耗时：0.001s</li>
<li>explain:使用索引</li>
</ul>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/方案/">方案</a>
    </span>
    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2021 vison
    
  </p>
</footer>
    
    
  </div>
</div>
</body>
</html>