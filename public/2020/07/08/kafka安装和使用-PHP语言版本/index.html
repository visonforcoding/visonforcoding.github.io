<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>kafka搭建和使用(PHP语言版本) | 麦田麦穗</title>

  
  <meta name="author" content="vison">
  

  
  <meta name="description" content="首先,安装确实是一个费时费力的事情。这里我们使用docker安装。">
  

  
  
  <meta name="keywords" content="kafka">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="kafka搭建和使用(PHP语言版本)"/>

  <meta property="og:site_name" content="麦田麦穗"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="麦田麦穗" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">麦田麦穗</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>kafka搭建和使用(PHP语言版本)</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2020/07/08/kafka安装和使用-PHP语言版本/" rel="bookmark">
        <time class="entry-date published" datetime="2020-07-08T08:13:45.000Z">
          2020-07-08
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p><img src="http://img.rc5j.cn/blog20200723094704.png" alt=""></p>
<p>首先,安装确实是一个费时费力的事情。这里我们使用docker安装。</p>
<span id="more"></span>

<h2 id="docker搭建kafka"><a href="#docker搭建kafka" class="headerlink" title="docker搭建kafka"></a>docker搭建kafka</h2><pre><code class="yml">## docker-compose.yml
version: &#39;3.1&#39;
services:
    zookeeper:
        image: wurstmeister/zookeeper
        ports:
          - &quot;2181:2181&quot;
    kafka:
        image: wurstmeister/kafka
        ports:
          - &quot;9092:9092&quot;
        environment:
           KAFKA_ADVERTISED_HOST_NAME: 172.17.0.1
           KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
           KAFKA_ADVERTISED_PORT: 9092</code></pre>
<p>更多细节建议访问官方文档查阅。</p>
<h2 id="PHP实现"><a href="#PHP实现" class="headerlink" title="PHP实现"></a>PHP实现</h2><h3 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h3><pre><code class="PHP"> public function kafka(Request $request)
    &#123;
        $faker = Factory::create(&#39;zh_CN&#39;);
        $message = $faker-&gt;name();
        Log::debug(&#39;消息&#39;, [&#39;message&#39; =&gt; $message]);

        $conf = new Conf();
        $conf-&gt;set(&#39;log_level&#39;, (string) LOG_DEBUG);
        $conf-&gt;set(&#39;debug&#39;, &#39;all&#39;);
        $conf-&gt;set(&#39;metadata.broker.list&#39;, &#39;127.0.0.1:9092&#39;);
        $conf-&gt;setDrMsgCb(function ($kafka, $message) &#123;
            Log::debug(&quot;kafka信息&quot;, [&#39;message&#39; =&gt; var_export($message, true)]);
        &#125;);
        $conf-&gt;setErrorCb(function ($kafka, $err, $reason) &#123;
            Log::debug(&quot;kafka错误&quot;, [&#39;err&#39; =&gt; $err, &#39;reason&#39; =&gt; $reason]);
        &#125;);

        $conf-&gt;setLogCb(function ($kafka, $level, $facility, $message) &#123;
            Log::debug(vsprintf(&quot;Kafka %s: %s (level: %d)\n&quot;, [$facility, $message, $level]));
        &#125;);

        //If you need to produce exactly once and want to keep the original produce order, uncomment the line below
        //$conf-&gt;set(&#39;enable.idempotence&#39;, &#39;true&#39;);

        $producer = new Producer($conf);

        $topic = $producer-&gt;newTopic(&quot;test&quot;);
        $topic-&gt;produce(RD_KAFKA_PARTITION_UA, 0, $faker-&gt;name());
        $producer-&gt;poll(0);

        $result = $producer-&gt;flush(10000);
        if (RD_KAFKA_RESP_ERR_NO_ERROR !== $result) &#123;
            throw new \RuntimeException(&#39;Was unable to flush, messages might be lost!&#39;);
        &#125;

        return new ActionResponse($result);
    &#125;</code></pre>
<h3 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h3><pre><code class="PHP">public function consume()
    &#123;
        $conf = new Conf();

// Configure the group.id. All consumer with the same group.id will consume
// different partitions.
        $conf-&gt;set(&#39;group.id&#39;, &#39;myConsumerGroup&#39;);

// Initial list of Kafka brokers
        $conf-&gt;set(&#39;metadata.broker.list&#39;, &#39;127.0.0.1&#39;);

// Set where to start consuming messages when there is no initial offset in
// offset store or the desired offset is out of range.
// &#39;smallest&#39;: start from the beginning
        $conf-&gt;set(&#39;auto.offset.reset&#39;, &#39;smallest&#39;);

        $consumer = new KafkaConsumer($conf);

// Subscribe to topic &#39;test&#39;
        $consumer-&gt;subscribe([&#39;test&#39;]);

        echo &quot;Waiting for partition assignment... (make take some time when\n&quot;;
        echo &quot;quickly re-joining the group after leaving it.)\n&quot;;

        while (true) &#123;
            $message = $consumer-&gt;consume(120 * 1000);
            switch ($message-&gt;err) &#123;
                case RD_KAFKA_RESP_ERR_NO_ERROR:
                    $this-&gt;info($message-&gt;payload);
                    break;
                case RD_KAFKA_RESP_ERR__PARTITION_EOF:
                    echo &quot;No more messages; will wait for more\n&quot;;
                    break;
                case RD_KAFKA_RESP_ERR__TIMED_OUT:
                    $this-&gt;info(&quot;Timed out&quot;);
                    break;
                default:
                    throw new Exception($message-&gt;errstr(), $message-&gt;err);
                    break;
            &#125;
        &#125;
    &#125;</code></pre>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>生产者是一个restful的api，直接调用会往kafka里写入1个中文姓名的消息。</p>
<p>消费者是一个PHP脚本进程，启动会开始消费kafka消息</p>
<pre><code class="shell">php bin/cli.php kafka consume</code></pre>
<p><img src="http://img.rc5j.cn/blog20200709115956.png" alt=""></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>虽然已经搭建了kafka<code>消息中间件</code>,和编写了<code>生产者</code>和<code>消费者</code>.但是关于其中的许多细节还要搞清除。包括:</p>
<ul>
<li>什么是broken</li>
<li>什么是partition</li>
<li>消息flush是做什么</li>
<li>poll又是做什么</li>
<li>等等更多细节</li>
</ul>
<h2 id="broken"><a href="#broken" class="headerlink" title="broken"></a>broken</h2>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/kafka/">kafka</a>
    </span>
    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2021 vison
    
  </p>
</footer>
    
    
  </div>
</div>
</body>
</html>