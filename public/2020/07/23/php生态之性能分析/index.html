<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>php生态之性能分析 | 麦田麦穗</title>

  
  <meta name="author" content="vison">
  

  
  <meta name="description" content="一般情况下我们并不会太关注PHP的执行效率，因为一般而言他都表现正常满足需求。但当真正遇到问题的时候，我们需要有分析性能在哪丢失的能力。">
  

  
  
  <meta name="keywords" content="php">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="php生态之性能分析"/>

  <meta property="og:site_name" content="麦田麦穗"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="麦田麦穗" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">麦田麦穗</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>php生态之性能分析</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2020/07/23/php生态之性能分析/" rel="bookmark">
        <time class="entry-date published" datetime="2020-07-23T07:00:58.000Z">
          2020-07-23
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p><img src="http://img.rc5j.cn/blog20200724153643.png" alt=""></p>
<p>一般情况下我们并不会太关注PHP的执行效率，因为一般而言他都表现正常满足需求。但当真正遇到问题的时候，我们需要有分析性能在哪丢失的能力。</p>
<span id="more"></span>

<p><code>xhprof</code>正是这样的工具。但是由于年久失修，目前已经不支持PHP7 .</p>
<p><img src="http://img.rc5j.cn/blog20200724154122.png" alt=""></p>
<p>不过，好在还有非官方商业组织开源了PHP7版本,<code>tideways-xhprof</code>。</p>
<p><img src="http://img.rc5j.cn/blog20200724154306.gif" alt=""></p>
<p>官网  <a target="_blank" rel="noopener" href="https://tideways.com/profiler/xhprof-for-php7">https://tideways.com/profiler/xhprof-for-php7</a></p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><pre><code class="shell">git clone &quot;https://github.com/tideways/php-xhprof-extension.git&quot;
cd php-xhprof-extension
phpize
./configure
make
sudo make install</code></pre>
<p>配置好ini，重启查看下php -m</p>
<h2 id="图形化"><a href="#图形化" class="headerlink" title="图形化"></a>图形化</h2><p><code>tideways-xhprof</code> 可以将分析出方法调用、方法调用过程和性能消耗数据。</p>
<p><code>tideways-xhprof</code> 本身还提供商业化服务，有着比较好的体验。不过也同时有开源的图形化工具。比较好的是<code>xhgui</code>和他配套的是<code>perftools/php-profiler</code>.看了下作者，还是<code>markstory</code>，cakephp的作者，几年前使用cakephp的时候，还有过交流。</p>
<h2 id="xgui安装"><a href="#xgui安装" class="headerlink" title="xgui安装"></a>xgui安装</h2><p>可以选择源码部署，也可以选择docker部署。方便点选择使用docker。</p>
<ol>
<li><p>Clone or download xhgui from GitHub.</p>
</li>
<li><p>Startup the containers: docker-compose up -d</p>
</li>
<li><p>Open your browser at <a target="_blank" rel="noopener" href="http://xhgui.127.0.0.1.xip.io:8142">http://xhgui.127.0.0.1.xip.io:8142</a> or just <a target="_blank" rel="noopener" href="http://localhost:8142">http://localhost:8142</a></p>
</li>
</ol>
<h2 id="php-profiler使用"><a href="#php-profiler使用" class="headerlink" title="php-profiler使用"></a>php-profiler使用</h2><p>官方github上写几种接入方式，我推荐用注册shutdown方式，正在对项目代码无入侵。保存过程在shutdown之后。</p>
<pre><code class="PHP"> $profiler = new \Xhgui\Profiler\Profiler($config);

    // The profiler itself checks whether it should be enabled
    // for request (executes lambda function from config)
$profiler-&gt;enable();

    // shutdown handler collects and stores the data.
$profiler-&gt;registerShutdownHandler();</code></pre>
<p>上面的<code>$config</code>，在使用非文件存储的时候要注意不要安装官方配置来，官方配置目前存在一点问题，新配置会不生效。我看了源码，并且提交了PR。</p>
<pre><code class="PHP">//    &#39;db.host&#39; =&gt; &#39;mongodb://127.0.0.1:27018&#39;,
//    &#39;db.db&#39; =&gt; &#39;xhprof&#39;,
    &#39;save.handler.mongodb&#39; =&gt; array(
        &#39;dsn&#39; =&gt; &#39;mongodb://127.0.0.1:27018&#39;,
        &#39;database&#39; =&gt; &#39;xhprof&#39;,
        // Allows you to pass additional options like replicaSet to MongoClient.
        // &#39;username&#39;, &#39;password&#39; and &#39;db&#39; (where the user is added)
        &#39;options&#39; =&gt; array(),
    ),</code></pre>
<p>注释部分才有效.</p>
<h2 id="默认配置"><a href="#默认配置" class="headerlink" title="默认配置"></a>默认配置</h2><pre><code class="PHP">&lt;?php
/**
 * Default configuration for Xhgui
 */

$mongoUri = getenv(&#39;XHGUI_MONGO_URI&#39;) ?: &#39;127.0.0.1:27017&#39;;
$mongoUri = str_replace(&#39;mongodb://&#39;, &#39;&#39;, $mongoUri);
$mongoDb = getenv(&#39;XHGUI_MONGO_DB&#39;) ?: &#39;xhprof&#39;;

return array(
    &#39;debug&#39; =&gt; false,
    &#39;mode&#39; =&gt; &#39;development&#39;,

    // Can be mongodb, file or upload.

    // For file
    //
    //&#39;save.handler&#39; =&gt; &#39;file&#39;,
    //&#39;save.handler.filename&#39; =&gt; dirname(__DIR__) . &#39;/cache/&#39; . &#39;xhgui.data.&#39; . microtime(true) . &#39;_&#39; . substr(md5($url), 0, 6),

    // For upload
    //
    // Saving profile data by upload is only recommended with HTTPS
    // endpoints that have IP whitelists applied.
    //
    // The timeout option is in seconds and defaults to 3 if unspecified.
    //
    //&#39;save.handler&#39; =&gt; &#39;upload&#39;,
    //&#39;save.handler.upload.uri&#39; =&gt; &#39;https://example.com/run/import&#39;,
    //&#39;save.handler.upload.timeout&#39; =&gt; 3,

    // For MongoDB
    &#39;save.handler&#39; =&gt; &#39;mongodb&#39;,
    &#39;db.host&#39; =&gt; sprintf(&#39;mongodb://%s&#39;, $mongoUri),
    &#39;db.db&#39; =&gt; $mongoDb,

    &#39;pdo&#39; =&gt; array(
        &#39;dsn&#39; =&gt; &#39;sqlite:/tmp/xhgui.sqlite3&#39;,
        &#39;user&#39; =&gt; null,
        &#39;pass&#39; =&gt; null,
        &#39;table&#39; =&gt; &#39;results&#39;
    ),

    // Allows you to pass additional options like replicaSet to MongoClient.
    // &#39;username&#39;, &#39;password&#39; and &#39;db&#39; (where the user is added)
    &#39;db.options&#39; =&gt; array(),
    &#39;templates.path&#39; =&gt; dirname(__DIR__) . &#39;/src/templates&#39;,
    &#39;date.format&#39; =&gt; &#39;M jS H:i:s&#39;,
    &#39;detail.count&#39; =&gt; 6,
    &#39;page.limit&#39; =&gt; 25,

    // call fastcgi_finish_request() in shutdown handler
    &#39;fastcgi_finish_request&#39; =&gt; true,

    // Profile x in 100 requests. (E.g. set XHGUI_PROFLING_RATIO=50 to profile 50% of requests)
    // You can return true to profile every request.
    &#39;profiler.enable&#39; =&gt; function() &#123;
        $ratio = getenv(&#39;XHGUI_PROFILING_RATIO&#39;) ?: 100;
        return (getenv(&#39;XHGUI_PROFILING&#39;) !== false) &amp;&amp; (mt_rand(1, 100) &lt;= $ratio);
    &#125;,

    &#39;profiler.simple_url&#39; =&gt; function($url) &#123;
        return preg_replace(&#39;/\=\d+/&#39;, &#39;&#39;, $url);
    &#125;,

    //&#39;profiler.replace_url&#39; =&gt; function($url) &#123;
    //    return str_replace(&#39;token&#39;, &#39;&#39;, $url);
    //&#125;,

    &#39;profiler.options&#39; =&gt; array(),

    &#39;profiler.skip_built_in&#39; =&gt; false,
);
</code></pre>
<p>以上是默认配置</p>
<h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p><img src="http://img.rc5j.cn/blog20200724134032.png" alt=""></p>
<p>图中可以看到,每次请求的花费时间。</p>
<p><img src="http://img.rc5j.cn/blog20200724165205.png" alt=""></p>
<p><img src="http://img.rc5j.cn/blog20200724165354.png" alt=""></p>
<p>通过观察方法调用次数，可以发现symfony ErrorHandler这个组件方法执行的特别多。</p>
<p>于是我取消了这个组件，发现接口请求时间从<code>113ms</code>直接就降到了<code>71ms</code>.</p>
<p><strong>这就是很直观的性能定位了</strong></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/php/">php</a>
    </span>
    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2021 vison
    
  </p>
</footer>
    
    
  </div>
</div>
</body>
</html>